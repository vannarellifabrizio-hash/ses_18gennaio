<!doctype html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Gestione Attivit√† Progetti</title>

  <!-- Supabase JS (UMD) -->
  <script defer src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.45.4/dist/umd/supabase.js"></script>

  <!-- PDF export -->
  <script defer src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
  <script defer src="https://cdn.jsdelivr.net/npm/jspdf-autotable@3.8.2/dist/jspdf.plugin.autotable.min.js"></script>

  <style>
    :root{
      --bg:#0b1020;
      --panel:#111a33;
      --panel2:#0f1730;
      --text:#e8ecff;
      --muted:#aab3d6;
      --line:rgba(255,255,255,.10);
      --green:#2ecc71;
      --orange:#f39c12;
      --red:#e74c3c;
      --btn:#2f5bff;
      --btn2:#203a8a;
      --danger:#ff3b3b;
      --ok:#27ae60;
    }
    *{ box-sizing:border-box; }
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
      background: radial-gradient(1000px 700px at 20% 10%, #1b2b77 0%, transparent 60%),
                  radial-gradient(900px 600px at 80% 0%, #3b145e 0%, transparent 55%),
                  var(--bg);
      color:var(--text);
    }
    .container{ max-width:1100px; margin:0 auto; padding:24px; }
    .topbar{
      display:flex; align-items:center; justify-content:space-between;
      gap:12px; padding:14px 16px;
      background:rgba(0,0,0,.18);
      border:1px solid var(--line);
      border-radius:16px;
      backdrop-filter: blur(8px);
      position: sticky; top: 12px; z-index: 5;
    }
    .brand{ font-weight:800; letter-spacing:.2px; }
    .pill{
      display:inline-flex; align-items:center; gap:8px;
      padding:6px 10px; border-radius:999px; border:1px solid var(--line);
      color:var(--muted);
      background:rgba(255,255,255,.04);
      font-size:13px;
    }
    .grid{
      display:grid;
      grid-template-columns: repeat(12, 1fr);
      gap:14px;
      margin-top:16px;
    }
    .card{
      background:rgba(255,255,255,.04);
      border:1px solid var(--line);
      border-radius:18px;
      padding:16px;
      box-shadow: 0 10px 30px rgba(0,0,0,.18);
    }
    .card h2{ margin:0 0 8px; font-size:18px; }
    .card h3{ margin:0 0 8px; font-size:16px; }
    .muted{ color:var(--muted); }
    .row{ display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
    .col{ display:flex; flex-direction:column; gap:8px; }
    label{ font-size:13px; color:var(--muted); }
    input, select, textarea{
      width:100%;
      padding:10px 12px;
      border-radius:12px;
      border:1px solid var(--line);
      background:rgba(0,0,0,.22);
      color:var(--text);
      outline:none;
    }
    textarea{ min-height:80px; resize:vertical; }
    input:focus, select:focus, textarea:focus{ border-color: rgba(47,91,255,.6); box-shadow:0 0 0 3px rgba(47,91,255,.18); }
    .btn{
      appearance:none;
      border:1px solid rgba(255,255,255,.14);
      background: linear-gradient(180deg, rgba(47,91,255,.95), rgba(32,58,138,.95));
      color:white;
      padding:10px 12px;
      border-radius:12px;
      cursor:pointer;
      font-weight:700;
      transition: transform .05s ease, filter .15s ease;
      display:inline-flex; align-items:center; justify-content:center;
      gap:8px;
      min-height:40px;
    }
    .btn:hover{ filter: brightness(1.06); }
    .btn:active{ transform: translateY(1px); }
    .btn.secondary{
      background: rgba(255,255,255,.05);
      color: var(--text);
    }
    .btn.danger{
      background: rgba(255,59,59,.12);
      border-color: rgba(255,59,59,.35);
      color: #ffd6d6;
    }
    .btn.small{ padding:6px 10px; border-radius:10px; min-height:32px; font-size:13px; }
    .split{ display:grid; grid-template-columns: 1fr 1fr; gap:12px; }
    .span-12{ grid-column: span 12; }
    .span-8{ grid-column: span 8; }
    .span-6{ grid-column: span 6; }
    .span-4{ grid-column: span 4; }
    .span-3{ grid-column: span 3; }
    @media (max-width: 900px){
      .span-8,.span-6,.span-4,.span-3{ grid-column: span 12; }
      .split{ grid-template-columns:1fr; }
      .topbar{ position: static; }
    }
    .divider{ height:1px; background:var(--line); margin:12px 0; }
    .badge{
      display:inline-flex; align-items:center; gap:8px;
      padding:6px 10px; border-radius:999px;
      border:1px solid var(--line); font-size:12px; color:var(--muted);
      background: rgba(255,255,255,.04);
    }
    .square{ width:10px; height:10px; border-radius:3px; display:inline-block; }
    .status{
      display:flex; align-items:center; justify-content:flex-end; gap:10px;
      font-size:13px; color:var(--muted);
    }
    .project-title{
      display:flex; align-items:flex-start; justify-content:space-between; gap:12px;
    }
    .project-meta{ font-size:13px; color:var(--muted); line-height:1.35; }
    .resources{ margin-top:6px; font-size:13px; }
    .resources b{ color: var(--text); }
    ul.activities{ margin:10px 0 0; padding-left:18px; }
    ul.activities li{ margin:8px 0; line-height:1.35; }
    .nameTag{ font-weight:800; margin-right:6px; }
    .dateTag{ color:var(--muted); margin-right:8px; font-size:12px; }
    .activityText{ color:var(--text); }
    .inline-actions{ display:inline-flex; gap:6px; margin-left:10px; vertical-align:middle; }
    .toast{
      position: fixed; left: 50%; bottom: 18px; transform: translateX(-50%);
      background: rgba(0,0,0,.55); border:1px solid var(--line);
      padding:10px 12px; border-radius:12px; color:var(--text);
      backdrop-filter: blur(8px);
      display:none;
      z-index: 50;
    }
    .modal-back{
      position:fixed; inset:0;
      background: rgba(0,0,0,.55);
      display:none;
      align-items:center; justify-content:center;
      padding:18px;
      z-index: 60;
    }
    .modal{
      width:min(520px, 100%);
      background: rgba(17,26,51,.96);
      border:1px solid var(--line);
      border-radius:18px;
      padding:16px;
      box-shadow: 0 20px 60px rgba(0,0,0,.35);
    }
    .modal h2{ margin:0 0 8px; }
    .hint{ font-size:12px; color:var(--muted); }
    .kpi{
      display:flex; align-items:center; justify-content:space-between;
      padding:10px 12px; border-radius:14px; border:1px solid var(--line);
      background: rgba(255,255,255,.03);
    }
    .dot{ width:10px; height:10px; border-radius:999px; display:inline-block; }
    .mono{ font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace; }
    .loading{
      display:flex; align-items:center; justify-content:center;
      padding:30px; color:var(--muted);
    }
  </style>
</head>

<body>
  <div class="container">
    <div class="topbar">
      <div class="row" style="gap:12px;">
        <div class="brand">üìå Gestione Attivit√†</div>
        <div class="pill" id="modePill">Modalit√†: Home</div>
      </div>
      <div class="row">
        <button class="btn secondary" id="btnHome">Home</button>
        <button class="btn secondary" id="btnLogout">Logout</button>
      </div>
    </div>

    <div id="app"></div>
  </div>

  <div class="toast" id="toast"></div>

  <div class="modal-back" id="modalBack">
    <div class="modal">
      <h2 id="modalTitle">Titolo</h2>
      <div id="modalBody"></div>
      <div class="divider"></div>
      <div class="row" style="justify-content:flex-end;">
        <button class="btn secondary" id="modalCancel">Annulla</button>
        <button class="btn" id="modalOk">OK</button>
      </div>
    </div>
  </div>

<script>
/** =========================
 *  CONFIG: incolla qui i tuoi valori Supabase
 *  ========================= */
const SUPABASE_URL = https://racadmooyexenfxylswt.supabase.co;
const SUPABASE_ANON_KEY = "sb_publishable_HQVc-OsQVHGcQpkwBEillQ_LjzKwMWV";

/** Email fisse per admin/dashboard (password la digiti tu, non √® nel codice) */
const ADMIN_EMAIL = "admin@app.local";
const DASH_EMAIL  = "dashboard@app.local";

/** =========================
 *  UI State
 *  ========================= */
const UI = {
  mode: "home", // home | admin | collab | dash
  collabSession: null, // { collabId, collabUserId, name, color }
  showAllByProject: {},
  dashShowAllByProject: {},
  draftByProject: {},          // IMPORTANTISSIMO: evita bug cursore (non salva su DB mentre scrivi)
  editDraftByActivity: {},
  filters: { datePreset:"all", dateFrom:"", dateTo:"", projectId:"all", collabId:"all" },
  cache: { collaborators: [], projects: [], activities: [] },
  loading: false
};

const appEl = document.getElementById("app");

function setModePill(text){ document.getElementById("modePill").textContent = "Modalit√†: " + text; }
function toast(msg){
  const el = document.getElementById("toast");
  el.textContent = msg;
  el.style.display = "block";
  clearTimeout(toast._t);
  toast._t = setTimeout(()=> el.style.display="none", 2200);
}
function nowISO(){ return new Date().toISOString(); }
function formatDateIT(iso){
  try{
    const d = new Date(iso);
    return d.toLocaleDateString("it-IT", { day:"2-digit", month:"2-digit", year:"numeric" }) + " " +
           d.toLocaleTimeString("it-IT", { hour:"2-digit", minute:"2-digit" });
  }catch{ return iso; }
}
function formatDayIT(iso){
  try{
    const d = new Date(iso);
    return d.toLocaleDateString("it-IT", { day:"2-digit", month:"2-digit", year:"numeric" });
  }catch{ return iso; }
}
function daysBetween(aISO, bISO){
  const a = new Date(aISO).setHours(0,0,0,0);
  const b = new Date(bISO).setHours(0,0,0,0);
  return Math.floor((a - b) / (24*3600*1000));
}
function escapeHtml(str){
  return String(str ?? "")
    .replaceAll("&","&amp;")
    .replaceAll("<","&lt;")
    .replaceAll(">","&gt;")
    .replaceAll('"',"&quot;")
    .replaceAll("'","&#039;");
}
function escapeAttr(str){ return escapeHtml(str).replaceAll("`","&#096;"); }

/** =========================
 *  Modal
 *  ========================= */
function openModal({title, bodyHTML, okText="OK", cancelText="Annulla", onOk}){
  const back = document.getElementById("modalBack");
  document.getElementById("modalTitle").textContent = title;
  document.getElementById("modalBody").innerHTML = bodyHTML;
  document.getElementById("modalOk").textContent = okText;
  document.getElementById("modalCancel").textContent = cancelText;

  back.style.display = "flex";

  function close(){
    back.style.display = "none";
    document.getElementById("modalOk").onclick = null;
    document.getElementById("modalCancel").onclick = null;
  }
  document.getElementById("modalCancel").onclick = ()=> close();
  document.getElementById("modalOk").onclick = async ()=>{
    const res = await onOk?.({ close });
    if(res !== "keep-open") close();
  };
}

/** =========================
 *  Supabase init
 *  ========================= */
function getSupabase(){
  if(!window.supabase) return null;
  if(!SUPABASE_URL || !SUPABASE_ANON_KEY || SUPABASE_URL.includes("PASTE_")) return null;
  return window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
}
const sb = getSupabase();

/** =========================
 *  DATA ACCESS (Supabase)
 *  ========================= */
async function fetchCollaboratorsPublic(){
  const { data, error } = await sb
    .from("collaborators")
    .select("id,name,color,email,user_id")
    .order("name", { ascending: true });
  if(error) throw error;
  return data || [];
}

async function fetchProjectsAuth(){
  const { data, error } = await sb
    .from("projects")
    .select("id,title,subtitle,start_date,end_date,created_at")
    .order("title", { ascending: true });
  if(error) throw error;
  return data || [];
}

async function fetchActivitiesForCurrentUser(){
  const { data, error } = await sb
    .from("activities")
    .select("id,project_id,collaborator_id,collaborator_user_id,text,created_at,updated_at")
    .order("created_at", { ascending: false });
  if(error) throw error;
  return data || [];
}

async function fetchAllActivitiesAdminDash(){
  const { data, error } = await sb
    .from("activities")
    .select("id,project_id,collaborator_id,collaborator_user_id,text,created_at,updated_at")
    .order("created_at", { ascending: false });
  if(error) throw error;
  return data || [];
}

async function insertActivity({ projectId, collaboratorId, collaboratorUserId, text }){
  const { error } = await sb
    .from("activities")
    .insert([{ project_id: projectId, collaborator_id: collaboratorId, collaborator_user_id: collaboratorUserId, text }]);
  if(error) throw error;
}

async function updateActivity({ id, text }){
  const { error } = await sb
    .from("activities")
    .update({ text })
    .eq("id", id);
  if(error) throw error;
}

async function deleteActivity(id){
  const { error } = await sb
    .from("activities")
    .delete()
    .eq("id", id);
  if(error) throw error;
}

async function adminCreateProject({ title, subtitle, start_date, end_date }){
  const { error } = await sb.from("projects").insert([{ title, subtitle, start_date, end_date }]);
  if(error) throw error;
}

async function adminUpdateProject({ id, title, subtitle, start_date, end_date }){
  const { error } = await sb.from("projects").update({ title, subtitle, start_date, end_date }).eq("id", id);
  if(error) throw error;
}

async function adminDeleteProject(id){
  const { error } = await sb.from("projects").delete().eq("id", id);
  if(error) throw error;
}

async function adminUpdateCollaborator({ id, name, color, email, user_id }){
  const { error } = await sb.from("collaborators").update({ name, color, email, user_id }).eq("id", id);
  if(error) throw error;
}

async function adminCreateCollaboratorRow({ name, color, email, user_id }){
  // Nota: non creiamo l'utente Auth qui (serve server). Qui creiamo solo la riga.
  const { error } = await sb.from("collaborators").insert([{ name, color, email, user_id }]);
  if(error) throw error;
}

async function adminDeleteCollaborator(id){
  const { error } = await sb.from("collaborators").delete().eq("id", id);
  if(error) throw error;
}

/** =========================
 *  Helpers
 *  ========================= */
function getCollaboratorById(list, id){ return list.find(c=>c.id===id) || null; }
function getProjectById(list, id){ return list.find(p=>p.id===id) || null; }

function projectStatus(p){
  const today = new Date();
  const end = new Date(p.end_date + "T23:59:59");
  return today > end ? "terminato" : "in corso";
}

function activitiesForProject(acts, projectId){
  return acts.filter(a=>a.project_id===projectId).sort((a,b)=> new Date(b.created_at)-new Date(a.created_at));
}

function activitiesForProjectAndUser(acts, projectId, userId){
  return acts
    .filter(a=>a.project_id===projectId && a.collaborator_user_id===userId)
    .sort((a,b)=> new Date(b.created_at)-new Date(a.created_at));
}

function uniqueCollabsInProject(acts, collaborators, projectId){
  const set = new Set(acts.filter(a=>a.project_id===projectId).map(a=>a.collaborator_user_id));
  return [...set].map(uid => collaborators.find(c=>c.user_id===uid)).filter(Boolean);
}

function lastActivityDateForCollab(acts, collaboratorUserId){
  const list = acts.filter(a=>a.collaborator_user_id===collaboratorUserId);
  if(!list.length) return null;
  list.sort((a,b)=> new Date(b.created_at) - new Date(a.created_at));
  return list[0].created_at;
}

function trafficColorForDate(iso){
  if(!iso) return "var(--red)";
  const diff = daysBetween(new Date().toISOString(), iso);
  if(diff <= 7) return "var(--green)";
  if(diff <= 10) return "var(--orange)";
  return "var(--red)";
}

function applyActivityFilters(acts, filters){
  let out = acts.slice();

  if(filters.projectId !== "all"){
    out = out.filter(a=>a.project_id === filters.projectId);
  }
  if(filters.collabId !== "all"){
    // qui usiamo collaborator_user_id
    out = out.filter(a=>a.collaborator_user_id === filters.collabId);
  }
  if(filters.datePreset === "last7"){
    const cutoff = new Date();
    cutoff.setDate(cutoff.getDate() - 7);
    out = out.filter(a=> new Date(a.created_at) >= cutoff);
  } else if(filters.datePreset === "custom"){
    const from = filters.dateFrom ? new Date(filters.dateFrom + "T00:00:00") : null;
    const to = filters.dateTo ? new Date(filters.dateTo + "T23:59:59") : null;
    if(from) out = out.filter(a=> new Date(a.created_at) >= from);
    if(to) out = out.filter(a=> new Date(a.created_at) <= to);
  }
  out.sort((a,b)=> new Date(b.created_at)-new Date(a.created_at));
  return out;
}

/** =========================
 *  AUTH helpers
 *  ========================= */
async function signInWithEmailPassword(email, password){
  const { data, error } = await sb.auth.signInWithPassword({ email, password });
  if(error) throw error;
  return data;
}
async function signOut(){
  await sb.auth.signOut();
  UI.mode = "home";
  UI.collabSession = null;
  UI.draftByProject = {};
  UI.editDraftByActivity = {};
  UI.showAllByProject = {};
  UI.dashShowAllByProject = {};
}

async function getSession(){
  const { data } = await sb.auth.getSession();
  return data.session || null;
}

async function getMyRole(){
  // user_roles √® accessibile solo all'admin (policy), quindi per dashboard non possiamo leggerlo direttamente.
  // Quindi: per capire se √® dashboard/admin, usiamo un "tentativo" su activities: se riesce a leggere tutti ‚Üí ok.
  // In pratica qui gestiamo la UI con "come sei entrato" (admin/dash).
  return null;
}

/** =========================
 *  RENDER controller
 *  ========================= */
async function render(){
  if(!sb){
    setModePill("Errore configurazione");
    appEl.innerHTML = `
      <div class="card span-12">
        <h2>Configurazione Supabase mancante</h2>
        <div class="muted">
          Devi inserire <b>Project URL</b> e <b>anon public key</b> nel file <span class="mono">index.html</span>.
        </div>
      </div>
    `;
    return;
  }

  UI.loading = true;
  appEl.innerHTML = `<div class="loading">Caricamento‚Ä¶</div>`;

  try{
    // Collaborators list pu√≤ essere letta anche anon (policy)
    UI.cache.collaborators = await fetchCollaboratorsPublic();

    const session = await getSession();

    // Se non loggato: home
    if(!session){
      UI.cache.projects = [];
      UI.cache.activities = [];
      UI.mode = "home";
      UI.loading = false;
      renderHome();
      return;
    }

    // Loggato: carichiamo progetti (richiede authenticated) e attivit√†
    UI.cache.projects = await fetchProjectsAuth();

    if(UI.mode === "collab"){
      UI.cache.activities = await fetchActivitiesForCurrentUser(); // policy: solo proprie
      UI.loading = false;
      renderCollaborator();
      return;
    }
    if(UI.mode === "admin" || UI.mode === "dash"){
      UI.cache.activities = await fetchAllActivitiesAdminDash(); // policy: admin/dashboard
      UI.loading = false;
      UI.mode === "admin" ? renderAdmin() : renderDashboard();
      return;
    }

    // Se siamo loggati ma in modalit√† home (es. refresh), rimandiamo a Home ma con logout disponibile
    UI.cache.activities = await fetchActivitiesForCurrentUser().catch(()=>[]);
    UI.loading = false;
    UI.mode = "home";
    renderHome();

  }catch(e){
    console.error(e);
    UI.loading = false;
    appEl.innerHTML = `
      <div class="card span-12">
        <h2>Errore</h2>
        <div class="muted">${escapeHtml(e.message || String(e))}</div>
        <div class="divider"></div>
        <div class="muted">Controlla anche che RLS e le policy siano state applicate correttamente.</div>
      </div>
    `;
  }
}

/** =========================
 *  HOME + LOGIN
 *  ========================= */
function renderHome(){
  setModePill("Home");

  const collabOptions = UI.cache.collaborators
    .map(c=> `<option value="${c.id}">${escapeHtml(c.name)}</option>`)
    .join("");

  appEl.innerHTML = `
    <div class="grid">
      <div class="card span-12">
        <h2>Accesso</h2>
        <div class="muted">Ora i dati sono su Supabase. Admin/Dashboard/Collaboratori usano Supabase Auth.</div>
      </div>

      <div class="card span-4">
        <h2>ADMIN</h2>
        <div class="muted">Accedi con password (utente admin@app.local).</div>
        <div class="divider"></div>
        <button class="btn" id="goAdmin">Entra come ADMIN</button>
      </div>

      <div class="card span-4">
        <h2>Collaboratori</h2>
        <div class="muted">Seleziona il tuo nome e inserisci password.</div>
        <div class="divider"></div>
        <button class="btn" id="goCollab">Entra come Collaboratore</button>
      </div>

      <div class="card span-4">
        <h2>Dashboard</h2>
        <div class="muted">Accedi con password (utente dashboard@app.local).</div>
        <div class="divider"></div>
        <button class="btn" id="goDash">Entra nella Dashboard</button>
      </div>
    </div>
  `;

  document.getElementById("goAdmin").onclick = ()=> openAdminLogin();
  document.getElementById("goCollab").onclick = ()=> openCollaboratorLogin();
  document.getElementById("goDash").onclick = ()=> openDashboardLogin();
}

function openAdminLogin(){
  openModal({
    title: "Accesso ADMIN",
    bodyHTML: `
      <div class="col">
        <label>Password</label>
        <input type="password" id="adminPass" placeholder="Inserisci password" autocomplete="off"/>
        <div class="hint">Email usata: admin@app.local (non serve inserirla).</div>
      </div>
    `,
    okText:"Entra",
    onOk: async ({close})=>{
      const pass = document.getElementById("adminPass").value || "";
      try{
        await signInWithEmailPassword(ADMIN_EMAIL, pass);
        UI.mode = "admin";
        UI.collabSession = null;
        close();
        await render();
      }catch(e){
        toast("Password ADMIN errata");
        return "keep-open";
      }
    }
  });
}

function openDashboardLogin(){
  openModal({
    title: "Accesso Dashboard",
    bodyHTML: `
      <div class="col">
        <label>Password</label>
        <input type="password" id="dashPass" placeholder="Inserisci password" autocomplete="off"/>
        <div class="hint">Email usata: dashboard@app.local (non serve inserirla).</div>
      </div>
    `,
    okText:"Entra",
    onOk: async ({close})=>{
      const pass = document.getElementById("dashPass").value || "";
      try{
        await signInWithEmailPassword(DASH_EMAIL, pass);
        UI.mode = "dash";
        UI.collabSession = null;
        close();
        await render();
      }catch(e){
        toast("Password Dashboard errata");
        return "keep-open";
      }
    }
  });
}

function openCollaboratorLogin(){
  const options = UI.cache.collaborators
    .map(c=> `<option value="${c.id}">${escapeHtml(c.name)}</option>`)
    .join("");

  openModal({
    title: "Accesso Collaboratore",
    bodyHTML: `
      <div class="col">
        <label>Nome</label>
        <select id="collabSel">${options}</select>

        <label>Password</label>
        <input type="password" id="collabPass" placeholder="Inserisci password" autocomplete="off"/>
        <div class="hint">La password √® quella creata in Supabase ‚Üí Authentication ‚Üí Users per quell'email.</div>
      </div>
    `,
    okText:"Entra",
    onOk: async ({close})=>{
      const collabId = document.getElementById("collabSel").value;
      const pass = document.getElementById("collabPass").value || "";

      const c = getCollaboratorById(UI.cache.collaborators, collabId);
      if(!c?.email || !c?.user_id){
        toast("Collaboratore non collegato: compila email + user_id in tabella collaborators (step 3.6).");
        return "keep-open";
      }

      try{
        await signInWithEmailPassword(c.email, pass);

        UI.mode = "collab";
        UI.collabSession = { collabId: c.id, collabUserId: c.user_id, name: c.name, color: c.color };
        close();
        await render();
      }catch(e){
        toast("Password errata");
        return "keep-open";
      }
    }
  });
}

/** =========================
 *  ADMIN
 *  ========================= */
function renderAdmin(){
  setModePill("ADMIN");

  const collabRows = UI.cache.collaborators.map(c=>{
    return `
      <div class="kpi">
        <div>
          <div style="display:flex; align-items:center; gap:10px;">
            <span class="square" style="background:${escapeAttr(c.color||"#fff")}"></span>
            <b>${escapeHtml(c.name)}</b>
          </div>
          <div class="muted" style="font-size:12px;">
            email: ${escapeHtml(c.email||"‚Äî")} <br/>
            user_id: <span class="mono">${escapeHtml(c.user_id||"‚Äî")}</span>
          </div>
        </div>
        <div class="row">
          <button class="btn secondary small" data-act="editCollab" data-id="${c.id}">Modifica</button>
          <button class="btn danger small" data-act="delCollab" data-id="${c.id}">Elimina</button>
        </div>
      </div>
    `;
  }).join("");

  const projectRows = UI.cache.projects.map(p=>{
    return `
      <div class="kpi">
        <div>
          <b>${escapeHtml(p.title)}</b>
          <div class="muted">${escapeHtml(p.subtitle||"")}</div>
          <div class="muted" style="font-size:12px;">${escapeHtml(p.start_date)} ‚Üí ${escapeHtml(p.end_date)}</div>
        </div>
        <div class="row">
          <button class="btn secondary small" data-act="editProject" data-id="${p.id}">Modifica</button>
          <button class="btn danger small" data-act="delProject" data-id="${p.id}">Elimina</button>
        </div>
      </div>
    `;
  }).join("");

  appEl.innerHTML = `
    <div class="grid">
      <div class="card span-12">
        <div class="row" style="justify-content:space-between;">
          <div>
            <h2>Pannello ADMIN</h2>
            <div class="muted">Gestione progetti e dati collaboratori (nome/colore/email/user_id).</div>
            <div class="hint">Creazione password/account collaboratori: per ora si fa in Supabase ‚Üí Authentication ‚Üí Users (Step 5 lo automatizziamo).</div>
          </div>
          <button class="btn secondary" id="adminBackHome">Esci</button>
        </div>
      </div>

      <div class="card span-6">
        <h3>Collaboratori</h3>
        <div class="divider"></div>

        <div class="split">
          <div class="col">
            <label>Nome</label>
            <input id="newCollabName" placeholder="Es. Mario Rossi" />
          </div>
          <div class="col">
            <label>Colore</label>
            <input id="newCollabColor" type="color" value="#7bed9f" />
          </div>
        </div>

        <div class="split" style="margin-top:10px;">
          <div class="col">
            <label>Email (deve esistere in Supabase Auth)</label>
            <input id="newCollabEmail" placeholder="es. mario@app.local" />
          </div>
          <div class="col">
            <label>User UID (da Authentication ‚Üí Users)</label>
            <input id="newCollabUserId" placeholder="incolla user uid" />
          </div>
        </div>

        <div class="row" style="margin-top:10px;">
          <button class="btn" id="addCollabRow">Crea riga collaboratore</button>
        </div>

        <div class="divider"></div>
        <div class="col" style="gap:10px;">
          ${collabRows || `<div class="muted">Nessun collaboratore.</div>`}
        </div>
      </div>

      <div class="card span-6">
        <h3>Progetti</h3>
        <div class="divider"></div>

        <div class="col">
          <label>Titolo</label>
          <input id="newProjTitle" placeholder="Titolo progetto" />
          <label>Sottotitolo</label>
          <input id="newProjSubtitle" placeholder="Sottotitolo" />
          <div class="split">
            <div class="col">
              <label>Data inizio</label>
              <input id="newProjStart" type="date" />
            </div>
            <div class="col">
              <label>Data fine</label>
              <input id="newProjEnd" type="date" />
            </div>
          </div>

          <div class="row" style="margin-top:10px;">
            <button class="btn" id="addProject">Crea progetto</button>
          </div>
        </div>

        <div class="divider"></div>
        <div class="col" style="gap:10px;">
          ${projectRows || `<div class="muted">Nessun progetto.</div>`}
        </div>
      </div>
    </div>
  `;

  document.getElementById("adminBackHome").onclick = async ()=>{
    UI.mode="home"; UI.collabSession=null;
    await signOut();
    await render();
  };

  document.getElementById("addCollabRow").onclick = async ()=>{
    const name = (document.getElementById("newCollabName").value||"").trim();
    const color = document.getElementById("newCollabColor").value || "#7bed9f";
    const email = (document.getElementById("newCollabEmail").value||"").trim();
    const user_id = (document.getElementById("newCollabUserId").value||"").trim();

    if(!name){ toast("Inserisci nome"); return; }
    if(!email){ toast("Inserisci email"); return; }
    if(!user_id){ toast("Inserisci user uid"); return; }

    try{
      await adminCreateCollaboratorRow({ name, color, email, user_id });
      toast("Collaboratore creato");
      await render();
    }catch(e){
      toast("Errore: " + (e.message||""));
    }
  };

  document.getElementById("addProject").onclick = async ()=>{
    const title = (document.getElementById("newProjTitle").value||"").trim();
    const subtitle = (document.getElementById("newProjSubtitle").value||"").trim();
    const start_date = document.getElementById("newProjStart").value;
    const end_date = document.getElementById("newProjEnd").value;

    if(!title){ toast("Inserisci titolo"); return; }
    if(!start_date || !end_date){ toast("Inserisci date"); return; }
    if(new Date(start_date) > new Date(end_date)){ toast("La data fine deve essere dopo la data inizio"); return; }

    try{
      await adminCreateProject({ title, subtitle, start_date, end_date });
      toast("Progetto creato");
      await render();
    }catch(e){
      toast("Errore: " + (e.message||""));
    }
  };

  appEl.querySelectorAll("button[data-act]").forEach(btn=>{
    btn.onclick = async ()=>{
      const act = btn.getAttribute("data-act");
      const id = btn.getAttribute("data-id");

      if(act==="delProject"){
        openModal({
          title:"Elimina progetto",
          bodyHTML:`<div class="muted">Eliminare questo progetto? Verranno eliminate anche le attivit√†.</div>`,
          okText:"Elimina",
          onOk: async ()=>{
            await adminDeleteProject(id);
            toast("Progetto eliminato");
            await render();
          }
        });
      }

      if(act==="editProject"){
        const p = getProjectById(UI.cache.projects, id);
        if(!p) return;
        openModal({
          title:"Modifica progetto",
          bodyHTML: `
            <div class="col">
              <label>Titolo</label>
              <input id="epTitle" value="${escapeAttr(p.title)}" />
              <label>Sottotitolo</label>
              <input id="epSub" value="${escapeAttr(p.subtitle||"")}" />
              <div class="split">
                <div class="col">
                  <label>Data inizio</label>
                  <input id="epStart" type="date" value="${escapeAttr(p.start_date)}" />
                </div>
                <div class="col">
                  <label>Data fine</label>
                  <input id="epEnd" type="date" value="${escapeAttr(p.end_date)}" />
                </div>
              </div>
            </div>
          `,
          okText:"Salva",
          onOk: async ()=>{
            const title = (document.getElementById("epTitle").value||"").trim();
            const subtitle = (document.getElementById("epSub").value||"").trim();
            const start_date = document.getElementById("epStart").value;
            const end_date = document.getElementById("epEnd").value;
            if(!title){ toast("Titolo non valido"); return "keep-open"; }
            if(new Date(start_date) > new Date(end_date)){ toast("Date non valide"); return "keep-open"; }
            await adminUpdateProject({ id, title, subtitle, start_date, end_date });
            toast("Progetto aggiornato");
            await render();
          }
        });
      }

      if(act==="delCollab"){
        openModal({
          title:"Elimina collaboratore",
          bodyHTML:`<div class="muted">Eliminare questo collaboratore? Verranno eliminate anche le sue attivit√† (cascade).</div>`,
          okText:"Elimina",
          onOk: async ()=>{
            await adminDeleteCollaborator(id);
            toast("Collaboratore eliminato");
            await render();
          }
        });
      }

      if(act==="editCollab"){
        const c = getCollaboratorById(UI.cache.collaborators, id);
        if(!c) return;
        openModal({
          title:"Modifica collaboratore",
          bodyHTML: `
            <div class="col">
              <label>Nome</label>
              <input id="ecName" value="${escapeAttr(c.name)}" />
              <label>Colore</label>
              <input id="ecColor" type="color" value="${escapeAttr(c.color||"#7bed9f")}" />
              <label>Email (deve esistere in Auth)</label>
              <input id="ecEmail" value="${escapeAttr(c.email||"")}" />
              <label>User UID (Auth Users)</label>
              <input id="ecUserId" value="${escapeAttr(c.user_id||"")}" />
            </div>
          `,
          okText:"Salva",
          onOk: async ()=>{
            const name = (document.getElementById("ecName").value||"").trim();
            const color = document.getElementById("ecColor").value || "#7bed9f";
            const email = (document.getElementById("ecEmail").value||"").trim();
            const user_id = (document.getElementById("ecUserId").value||"").trim();
            if(!name){ toast("Nome non valido"); return "keep-open"; }
            await adminUpdateCollaborator({ id, name, color, email, user_id });
            toast("Collaboratore aggiornato");
            await render();
          }
        });
      }
    };
  });
}

/** =========================
 *  COLLABORATORE
 *  ========================= */
function renderCollaborator(){
  const session = UI.collabSession;
  if(!session){
    UI.mode="home";
    render();
    return;
  }

  setModePill("Collaboratore: " + session.name);

  const projects = UI.cache.projects.slice().sort((a,b)=> a.title.localeCompare(b.title, "it"));
  const acts = UI.cache.activities; // gi√† filtrate da RLS (solo sue)

  const cards = projects.map(p=>{
    const list = activitiesForProjectAndUser(acts, p.id, session.collabUserId);
    const showAll = !!UI.showAllByProject[p.id];
    const visible = showAll ? list : list.slice(0,10);
    const draft = UI.draftByProject[p.id] ?? "";

    const items = visible.map(a=>{
      const editMode = UI.editDraftByActivity[a.id] !== undefined;
      const text = editMode ? UI.editDraftByActivity[a.id] : a.text;

      return `
        <li>
          <span class="nameTag" style="color:${escapeAttr(session.color||"#fff")}">${escapeHtml(session.name)}</span>
          <span class="dateTag">${escapeHtml(formatDateIT(a.created_at))}</span>
          ${
            editMode
              ? `<textarea data-editarea="${a.id}">${escapeHtml(text)}</textarea>`
              : `<span class="activityText">${escapeHtml(text)}</span>`
          }
          <span class="inline-actions">
            ${
              editMode
              ? `
                <button class="btn small" data-act="saveEdit" data-id="${a.id}" data-pid="${p.id}">Salva</button>
                <button class="btn secondary small" data-act="cancelEdit" data-id="${a.id}" data-pid="${p.id}">Annulla</button>
              `
              : `
                <button class="btn secondary small" data-act="edit" data-id="${a.id}" data-pid="${p.id}">Modifica</button>
                <button class="btn danger small" data-act="delAct" data-id="${a.id}" data-pid="${p.id}">Elimina</button>
              `
            }
          </span>
        </li>
      `;
    }).join("");

    return `
      <div class="card span-6">
        <div class="project-title">
          <div>
            <h2 style="margin-bottom:4px;">${escapeHtml(p.title)}</h2>
            <div class="muted">${escapeHtml(p.subtitle||"")}</div>
            <div class="project-meta">${escapeHtml(p.start_date)} ‚Üí ${escapeHtml(p.end_date)}</div>
          </div>
          <div class="status">
            ${
              projectStatus(p)==="in corso"
              ? `<span class="badge"><span class="square" style="background:var(--green)"></span> in corso</span>`
              : `<span class="badge"><span class="square" style="background:var(--red)"></span> terminato</span>`
            }
          </div>
        </div>

        <div class="divider"></div>

        <div class="col">
          <label>Aggiungi attivit√† (si salva solo quando premi ‚ÄúSalva attivit√†‚Äù)</label>
          <textarea data-draft="${p.id}" placeholder="Scrivi qui...">${escapeHtml(draft)}</textarea>
          <div class="row">
            <button class="btn" data-act="addAct" data-pid="${p.id}">Salva attivit√†</button>
            <button class="btn secondary" data-act="clearDraft" data-pid="${p.id}">Svuota</button>
          </div>
        </div>

        <div class="divider"></div>

        <div class="row" style="justify-content:space-between;">
          <div class="muted">Le tue attivit√† (pi√π recente in alto)</div>
          ${
            list.length > 10
            ? `<button class="btn secondary small" data-act="toggle" data-pid="${p.id}">${showAll ? "Comprimi" : "Espandi"}</button>`
            : ``
          }
        </div>

        ${list.length ? `<ul class="activities">${items}</ul>` : `<div class="muted" style="margin-top:10px;">Nessuna attivit√† ancora.</div>`}
      </div>
    `;
  }).join("");

  appEl.innerHTML = `
    <div class="grid">
      <div class="card span-12">
        <div class="row" style="justify-content:space-between;">
          <div>
            <h2>Ciao ${escapeHtml(session.name)}</h2>
            <div class="muted">Vedi tutti i progetti, ma solo le tue attivit√† (RLS Supabase).</div>
          </div>
          <button class="btn secondary" id="collabExit">Esci</button>
        </div>
      </div>
      ${cards || `<div class="card span-12"><div class="muted">Nessun progetto.</div></div>`}
    </div>
  `;

  document.getElementById("collabExit").onclick = async ()=>{
    await signOut();
    toast("Logout effettuato");
    await render();
  };

  // DRAFT: solo memoria => nessun bug cursore
  appEl.querySelectorAll("textarea[data-draft]").forEach(t=>{
    const pid = t.getAttribute("data-draft");
    t.oninput = ()=> { UI.draftByProject[pid] = t.value; };
  });
  appEl.querySelectorAll("textarea[data-editarea]").forEach(t=>{
    const aid = t.getAttribute("data-editarea");
    t.oninput = ()=> { UI.editDraftByActivity[aid] = t.value; };
  });

  appEl.querySelectorAll("button[data-act]").forEach(btn=>{
    btn.onclick = async ()=>{
      const act = btn.getAttribute("data-act");
      const pid = btn.getAttribute("data-pid");
      const id = btn.getAttribute("data-id");

      if(act==="toggle"){ UI.showAllByProject[pid] = !UI.showAllByProject[pid]; renderCollaborator(); return; }
      if(act==="clearDraft"){ UI.draftByProject[pid] = ""; renderCollaborator(); return; }

      if(act==="addAct"){
        const text = (UI.draftByProject[pid] || "").trim();
        if(!text){ toast("Scrivi un'attivit√†"); return; }

        try{
          await insertActivity({
            projectId: pid,
            collaboratorId: session.collabId,
            collaboratorUserId: session.collabUserId,
            text
          });
          UI.draftByProject[pid] = "";
          toast("Attivit√† salvata");
          await render(); // ricarica da DB
        }catch(e){
          toast("Errore salvataggio: " + (e.message||""));
        }
        return;
      }

      if(act==="delAct"){
        openModal({
          title:"Elimina attivit√†",
          bodyHTML:`<div class="muted">Vuoi eliminare questa attivit√†?</div>`,
          okText:"Elimina",
          onOk: async ()=>{
            await deleteActivity(id);
            toast("Attivit√† eliminata");
            await render();
          }
        });
        return;
      }

      if(act==="edit"){
        const a = UI.cache.activities.find(x=>x.id===id);
        if(!a) return;
        UI.editDraftByActivity[id] = a.text;
        renderCollaborator();
        return;
      }

      if(act==="cancelEdit"){
        delete UI.editDraftByActivity[id];
        renderCollaborator();
        return;
      }

      if(act==="saveEdit"){
        const newText = (UI.editDraftByActivity[id] || "").trim();
        if(!newText){ toast("Testo vuoto"); return; }
        await updateActivity({ id, text: newText });
        delete UI.editDraftByActivity[id];
        toast("Modifica salvata");
        await render();
        return;
      }
    };
  });
}

/** =========================
 *  DASHBOARD
 *  ========================= */
function describeFilters(filters){
  const parts = [];
  if(filters.datePreset==="all") parts.push("Data: tutte");
  if(filters.datePreset==="last7") parts.push("Data: ultimi 7gg");
  if(filters.datePreset==="custom") parts.push(`Data: ${filters.dateFrom||"‚Äî"} ‚Üí ${filters.dateTo||"‚Äî"}`);
  if(filters.projectId!=="all") parts.push("Progetto selezionato");
  if(filters.collabId!=="all") parts.push("Collaboratore selezionato");
  return parts.join(" | ") || "nessuno";
}

function exportPdfTable(collaborators, projects, activities, filters){
  if(!window.jspdf || !window.jspdf.jsPDF){
    toast("Librerie PDF non caricate (riprova tra 1 secondo)");
    return;
  }
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF({ unit:"pt", format:"a4" });

  doc.setFont("helvetica","bold");
  doc.setFontSize(16);
  doc.text("Export Attivit√† (Tabella)", 40, 40);

  doc.setFont("helvetica","normal");
  doc.setFontSize(10);
  doc.text("Filtri: " + describeFilters(filters), 40, 58);

  const allActs = applyActivityFilters(activities, filters);

  // ordine: progetto, collaboratore, data desc
  const rowsSorted = allActs.slice().sort((a,b)=>{
    const pA = (getProjectById(projects,a.project_id)?.title || "").toLowerCase();
    const pB = (getProjectById(projects,b.project_id)?.title || "").toLowerCase();
    if(pA < pB) return -1;
    if(pA > pB) return 1;

    const cA = (collaborators.find(x=>x.user_id===a.collaborator_user_id)?.name || "").toLowerCase();
    const cB = (collaborators.find(x=>x.user_id===b.collaborator_user_id)?.name || "").toLowerCase();
    if(cA < cB) return -1;
    if(cA > cB) return 1;

    return new Date(b.created_at)-new Date(a.created_at);
  });

  let prevKey = null;
  const body = rowsSorted.map(a=>{
    const p = getProjectById(projects, a.project_id);
    const c = collaborators.find(x=>x.user_id===a.collaborator_user_id);
    const projName = p?.title || "‚Äî";
    const collName = c?.name || "‚Äî";
    const key = a.project_id + "|" + a.collaborator_user_id;

    const collCell = (prevKey === key) ? "" : collName;
    prevKey = key;

    const actText = `${formatDayIT(a.created_at)} ‚Äî ${a.text}`;
    return [projName, actText, collCell];
  });

  doc.autoTable({
    startY: 75,
    head: [["NOME PROGETTI", "ATTIVIT√Å SVOLTE", "COLLABORATORI"]],
    body,
    styles: { font:"helvetica", fontSize:9, cellPadding:6, overflow:"linebreak" },
    headStyles: { fillColor: [20, 30, 60] },
    columnStyles: { 0:{cellWidth:140}, 1:{cellWidth:280}, 2:{cellWidth:110} },
    didParseCell: function (hookData) {
      if(hookData.section === "body" && hookData.column.index === 2 && hookData.cell.raw === ""){
        hookData.cell.styles.textColor = [120,130,170];
        hookData.cell.styles.lineWidth = 0.2;
      }
    }
  });

  doc.save("export_attivita_tabella.pdf");
}

function exportPdfEditorial(collaborators, projects, activities, filters){
  if(!window.jspdf || !window.jspdf.jsPDF){
    toast("Librerie PDF non caricate (riprova tra 1 secondo)");
    return;
  }
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF({ unit:"pt", format:"a4" });

  doc.setFont("helvetica","bold");
  doc.setFontSize(16);
  doc.text("Export Attivit√† (Editoriale)", 40, 40);

  doc.setFont("helvetica","normal");
  doc.setFontSize(10);
  doc.text("Filtri: " + describeFilters(filters), 40, 58);

  const acts = applyActivityFilters(activities, filters);

  const byProject = new Map();
  for(const a of acts){
    if(!byProject.has(a.project_id)) byProject.set(a.project_id, []);
    byProject.get(a.project_id).push(a);
  }

  let y = 80;
  const projectIds = Array.from(byProject.keys()).sort((idA,idB)=>{
    return (getProjectById(projects,idA)?.title||"").localeCompare((getProjectById(projects,idB)?.title||""), "it");
  });

  for(const pid of projectIds){
    const p = getProjectById(projects, pid);
    const list = byProject.get(pid) || [];

    if(y > 760){ doc.addPage(); y = 40; }

    doc.setFont("helvetica","bold");
    doc.setFontSize(13);
    doc.text(p?.title || "Progetto", 40, y); y += 16;

    doc.setFont("helvetica","normal");
    doc.setFontSize(10);
    doc.text(`${p?.subtitle || ""}`, 40, y); y += 14;
    doc.text(`Date: ${p?.start_date || "‚Äî"} ‚Üí ${p?.end_date || "‚Äî"}  |  Stato: ${projectStatus(p||{end_date:"2099-01-01"})}`, 40, y); y += 14;

    const resources = uniqueCollabsInProject(list, collaborators, pid).map(c=>c.name).join(", ");
    doc.setFont("helvetica","bold"); doc.text("Risorse interessate: ", 40, y);
    doc.setFont("helvetica","normal"); doc.text(resources || "‚Äî", 160, y);
    y += 14;

    const byCollab = new Map();
    for(const a of list){
      if(!byCollab.has(a.collaborator_user_id)) byCollab.set(a.collaborator_user_id, []);
      byCollab.get(a.collaborator_user_id).push(a);
    }

    const body = [];
    const collabUserIds = Array.from(byCollab.keys()).sort((a,b)=>{
      const nA = (collaborators.find(x=>x.user_id===a)?.name||"");
      const nB = (collaborators.find(x=>x.user_id===b)?.name||"");
      return nA.localeCompare(nB, "it");
    });

    for(const cuid of collabUserIds){
      const c = collaborators.find(x=>x.user_id===cuid);
      const items = (byCollab.get(cuid) || [])
        .sort((a,b)=> new Date(b.created_at)-new Date(a.created_at))
        .map(a=> `‚Ä¢ ${formatDayIT(a.created_at)} ‚Äî ${a.text}`)
        .join("\n");

      body.push([c?.name || "‚Äî", items]);
    }

    doc.autoTable({
      startY: y,
      head: [["COLLABORATORE", "ATTIVIT√Ä"]],
      body,
      styles: { font:"helvetica", fontSize:9, cellPadding:6, overflow:"linebreak" },
      headStyles: { fillColor: [20, 30, 60] },
      columnStyles: { 0:{cellWidth:140}, 1:{cellWidth:390} },
      margin: { left: 40, right: 40 }
    });

    y = doc.lastAutoTable.finalY + 18;
  }

  doc.save("export_attivita_editoriale.pdf");
}

function renderDashboard(){
  setModePill("Dashboard");

  const collaborators = UI.cache.collaborators.slice().sort((a,b)=> a.name.localeCompare(b.name, "it"));
  const projects = UI.cache.projects.slice().sort((a,b)=> a.title.localeCompare(b.title, "it"));
  const allActs = UI.cache.activities;

  const collabKpis = collaborators.map(c=>{
    const last = lastActivityDateForCollab(allActs, c.user_id);
    const dot = trafficColorForDate(last);
    return `
      <div class="kpi">
        <div>
          <div style="display:flex; align-items:center; gap:10px;">
            <span class="dot" style="background:${dot}"></span>
            <b>${escapeHtml(c.name)}</b>
            <span class="square" style="background:${escapeAttr(c.color||"#fff")}; margin-left:6px;"></span>
          </div>
          <div class="muted" style="font-size:12px;">
            Ultima attivit√†: ${last ? escapeHtml(formatDateIT(last)) : "‚Äî"}
          </div>
        </div>
      </div>
    `;
  }).join("");

  const projOpts = [`<option value="all">Tutti i progetti</option>`]
    .concat(projects.map(p=>`<option value="${p.id}">${escapeHtml(p.title)}</option>`)).join("");

  const collOpts = [`<option value="all">Tutti i collaboratori</option>`]
    .concat(collaborators.map(c=>`<option value="${c.user_id}">${escapeHtml(c.name)}</option>`)).join("");

  const projectCards = projects.map(p=>{
    const projActs = activitiesForProject(allActs, p.id);
    const filtered = applyActivityFilters(projActs, UI.filters);

    const showAll = !!UI.dashShowAllByProject[p.id];
    const visible = showAll ? filtered : filtered.slice(0,10);

    const resources = uniqueCollabsInProject(filtered, collaborators, p.id);
    const resNames = resources.map(r=>`<span style="margin-right:10px;"><b>${escapeHtml(r.name)}</b></span>`).join("");

    const items = visible.map(a=>{
      const coll = collaborators.find(c=>c.user_id===a.collaborator_user_id);
      const name = coll?.name || "Sconosciuto";
      const color = coll?.color || "#ffffff";
      return `
        <li>
          <span class="nameTag" style="color:${escapeAttr(color)}">${escapeHtml(name)}</span>
          <span class="dateTag">${escapeHtml(formatDateIT(a.created_at))}</span>
          <span class="activityText">${escapeHtml(a.text)}</span>
        </li>
      `;
    }).join("");

    return `
      <div class="card span-6">
        <div class="project-title">
          <div>
            <h2 style="margin
